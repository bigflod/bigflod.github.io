<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Resultados de búsqueda</title>
<link rel="stylesheet" href="css/styles.css">
<script src="https://unpkg.com/lunr/lunr.js"></script>
</head>
<body>

<h1>Resultados de búsqueda</h1>
<ul id="results" class="search-results"></ul>

<script>
  // --- Configuración ---
  const PAGES_JSON = '/assets/data/pages.json';

  // stopwords to ignore (Spanish minimal list)
  const STOPWORDS = [
    'a','al','algo','algunas','algunos','ante','antes','como','con','contra','cualquier',
    'de','del','desde','donde','durante','e','el','ella','ellas','ellos','en','entre',
    'era','erais','éramos','es','esa','esas','ese','esos','esta','estaba','estabais','estábamos',
    'están','están','este','esto','estos','etc','ha','hace','haces','hago','hasta','incluso',
    'la','las','le','les','lo','los','más','me','mi','mis','muy','ni','no','nos','nosotros','o',
    'por','para','pero','que','qué','quien','si','sí','sin','sobre','su','sus','también','tanto',
    'te','tu','tus','un','una','uno','unos','y','ya'
  ];

  // util: normalize and tokenize string
  function tokenize(text) {
    if (!text) return [];
    return text
      .toString()
      .toLowerCase()
      .replace(/[\u00A0\u2000-\u206F\s]+/g, ' ') // normalize spaces
      .replace(/[^a-z0-9áéíóúñç ]+/g, ' ') // remove punctuation
      .split(/\s+/)
      .map(t => t.trim())
      .filter(Boolean);
  }

  // util: remove stopwords
  function removeStopwords(tokens) {
    return tokens.filter(t => !STOPWORDS.includes(t));
  }

  // read query
  const urlParams = new URLSearchParams(window.location.search);
  const rawQuery = urlParams.get('q') || '';
  const query = rawQuery.trim();

  const resultsContainer = document.getElementById('results');

  if (!query) {
    resultsContainer.innerHTML = '<li class="no-results">Introduce un término de búsqueda</li>';
  } else {
    // fetch documents, build or reuse index
    fetch(PAGES_JSON)
      .then(r => {
        if (!r.ok) throw new Error('No se pudo cargar pages.json');
        return r.json();
      })
      .then(async documents => {
        // basic caching: reuse serialized index if doc count matches
        let idx = null;
        try {
          const cached = localStorage.getItem('lunr_index_v1');
          const cachedDocsCount = Number(localStorage.getItem('lunr_docs_count_v1') || '0');
          if (cached && cachedDocsCount === documents.length) {
            idx = lunr.Index.load(JSON.parse(cached));
          }
        } catch (err) {
          console.warn('Cache load failed', err);
          idx = null;
        }

        if (!idx) {
          // Build Lunr index using only `keywords` field with high boost
          idx = lunr(function() {
            // remove default stop word filter and add custom Spanish stopwords
            try { this.pipeline.remove(lunr.stopWordFilter); } catch (e) { /* ignore */ }
            try { this.pipeline.add(lunr.generateStopWordFilter(STOPWORDS)); } catch (e) { /* ignore */ }

            this.ref('url');
            this.field('keywords', { boost: 10 });

            // add documents
            documents.forEach(doc => {
              // ensure keywords is a string
              doc.keywords = (doc.keywords || '').toString();
              this.add({ url: doc.url, keywords: doc.keywords });
            });
          });

          // cache serialized index + doc count
          try {
            localStorage.setItem('lunr_index_v1', JSON.stringify(idx));
            localStorage.setItem('lunr_docs_count_v1', String(documents.length));
          } catch (err) {
            // ignore storage errors for privacy or quota
          }
        }

        // perform search: allow multiple words
        const rawTokens = removeStopwords(tokenize(query));
        if (rawTokens.length === 0) {
          resultsContainer.innerHTML = '<li class="no-results">La búsqueda contiene solo palabras vacías.</li>';
          return;
        }

        // Use Lunr search for relevance scores, but we'll re-rank by number of matching keyword tokens
        // Build a simple Lunr query combining terms
        const lunrQuery = rawTokens.join(' ');
        let lunrResults = [];
        try {
          lunrResults = idx.search(lunrQuery);
        } catch (err) {
          console.error('Lunr search failed', err);
          lunrResults = [];
        }

        // Map results to include matchCount (number of matched tokens against doc.keywords)
        const docsByUrl = {};
        documents.forEach(d => { docsByUrl[d.url] = d; });

        const scored = lunrResults.map(r => {
          const doc = docsByUrl[r.ref];
          const kwTokens = removeStopwords(tokenize(doc.keywords));
          // count unique token matches
          const matches = rawTokens.reduce((acc, t) => acc + (kwTokens.includes(t) ? 1 : 0), 0);
          return { ref: r.ref, score: r.score, matches, doc };
        });

        // sort by matches desc, then lunr score desc
        scored.sort((a,b) => {
          if (b.matches !== a.matches) return b.matches - a.matches;
          return b.score - a.score;
        });

        // render results
        if (scored.length === 0) {
          resultsContainer.innerHTML = '<li class="no-results">No se encontraron resultados</li>';
        } else {
          const frag = document.createDocumentFragment();
          scored.forEach(item => {
            const d = item.doc;
            const li = document.createElement('li');
            li.className = 'result';
            // accessible clickable block
            const a = document.createElement('a');
            a.href = d.url;
            a.innerHTML = `<strong>${escapeHtml(d.title || d.url)}</strong>`;
            const sum = document.createElement('span');
            sum.className = 'summary';
            sum.textContent = d.summary || '';
            a.appendChild(sum);
            li.appendChild(a);
            frag.appendChild(li);
          });
          resultsContainer.appendChild(frag);
        }
      })
      .catch(err => {
        console.error(err);
        resultsContainer.innerHTML = '<li class="no-results">Error cargando datos de búsqueda.</li>';
      });
  }

  // small helper to avoid injecting HTML from JSON
  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
</script>
</body>
</html>
