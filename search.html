<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex, follow">
<title>Resultados de búsqueda</title>

<script src="https://unpkg.com/lunr/lunr.js"></script>

<style>
:root {
  --bg: #ffffff;
  --surface: #f7f7f9;
  --border: #e5e7eb;
  --text: #1f2937;
  --muted: #6b7280;
  --accent: #3b82f6;
  --accent-soft: rgba(59,130,246,.08);
  --radius: 14px;
  --shadow: 0 10px 30px rgba(0,0,0,.06);
  --topHeader-h: 64px;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background: linear-gradient(180deg, #f8fafc, #ffffff);
  color: var(--text);
  min-height: 100vh;
}

/* layout */
main {
  max-width: 900px;
  margin: 0 auto;
  padding: clamp(1.5rem, 4vw, 3rem);
}

h1 {
  font-size: clamp(1.6rem, 3vw, 2.2rem);
  margin-bottom: 1.5rem;
  letter-spacing: -0.02em;
}

/* results list */
.search-results {
  list-style: none;
  padding: 0;
  margin: 0;
  display: grid;
  gap: 1rem;
}

/* result card */
.result {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;
}

.result:hover {
  transform: translateY(-2px);
  box-shadow: 0 14px 40px rgba(0,0,0,.1);
  border-color: var(--accent);
}

/* clickable block */
.result a {
  display: block;
  padding: 1.2rem 1.4rem;
  text-decoration: none;
  color: inherit;
}

/* title */
.result strong {
  display: block;
  font-size: 1.05rem;
  margin-bottom: .4rem;
  color: var(--accent);
}

/* summary */
.summary {
  display: block;
  font-size: .95rem;
  line-height: 1.5;
  color: var(--muted);
}

/* empty / error states */
.no-results {
  padding: 2rem;
  text-align: center;
  border-radius: var(--radius);
  background: var(--surface);
  border: 1px dashed var(--border);
  color: var(--muted);
  font-size: 1rem;
}

/* subtle highlight animation on load */
.result {
  animation: fadeUp .35s ease both;
}

@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* responsive tweaks */
@media (max-width: 600px) {
  .result a {
    padding: 1rem;
  }
  .summary {
    font-size: .9rem;
  }
}

/* Top header styles (minimal, keep fixed) */
#topHeader {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--topHeader-h);
  background: linear-gradient(180deg, #ffffff, #fbfdff);
  display: flex;
  align-items: center;
  z-index: 4000;
  border-bottom: 1px solid var(--border);
  box-shadow: 0 6px 18px rgba(0,0,0,0.03);
}

#searchContainerTop { display:flex; align-items:center; gap:0.6rem; padding:0 1rem; width:100%; }
#searchContainerTop .site-logo { width:34px; height:34px; display:block; margin-right:0.6rem; }
#topSearchInput { flex:1 1 auto; max-width:760px; padding:0.5rem 1rem; border-radius:28px; border:2px solid var(--accent); font-size:1rem; background:transparent; color:var(--text); }
#topSearchInput:focus { outline:none; box-shadow: 0 6px 18px rgba(59,130,246,0.08); }
#themeBtn { width:36px; height:36px; border-radius:50%; background:transparent; border:none; display:flex; align-items:center; justify-content:center; margin-left:0.6rem; cursor:pointer; }

/* push main content down so header doesn't overlap */
main { padding-top: calc(var(--topHeader-h) + 1rem); }
</style>
</head>

<body>

  <!-- Top header (fixed) copied/adapted from index.html -->
  <header id="topHeader">
    <div id="searchContainerTop">
      <a href="/" class="search-logo-top" aria-label="Inicio"><img src="assets/logo.svg" alt="Logo" class="site-logo"></a>
      <input id="topSearchInput" class="search-input" type="text" placeholder="Buscar...">
      <button id="themeBtn" class="theme-btn-top" aria-label="Cambiar tema">
        <img id="themeIcon" src="assets/moon-icon.svg" alt="Tema">
      </button>
      <div class="search-icon"></div>
    </div>

  </header>

<main>
  <h1>Resultados de búsqueda</h1>
  <ul id="results" class="search-results"></ul>
</main>

<script>
  // --- Configuración ---
  const PAGES_JSON = '/assets/data/pages.json';

  const STOPWORDS = [
    'a','al','algo','algunas','algunos','ante','antes','como','con','contra','cualquier',
    'de','del','desde','donde','durante','e','el','ella','ellas','ellos','en','entre',
    'era','erais','éramos','es','esa','esas','ese','esos','esta','estaba','estabais','estábamos',
    'están','este','esto','estos','etc','ha','hace','haces','hago','hasta','incluso',
    'la','las','le','les','lo','los','más','me','mi','mis','muy','ni','no','nos','nosotros','o',
    'por','para','pero','que','qué','quien','si','sí','sin','sobre','su','sus','también','tanto',
    'te','tu','tus','un','una','uno','unos','y','ya'
  ];

  function tokenize(text) {
    if (!text) return [];
    return text
      .toString()
      .toLowerCase()
      .replace(/[\u00A0\u2000-\u206F\s]+/g, ' ')
      .replace(/[^a-z0-9áéíóúñç ]+/g, ' ')
      .split(/\s+/)
      .map(t => t.trim())
      .filter(Boolean);
  }

  function removeStopwords(tokens) {
    return tokens.filter(t => !STOPWORDS.includes(t));
  }

  const urlParams = new URLSearchParams(window.location.search);
  const rawQuery = urlParams.get('q') || '';
  const query = rawQuery.trim();

  // --- Theme preference (persisted in localStorage) ---
  const THEME_KEY = 'theme_pref_v1';
  const themeBtn = document.getElementById('themeBtn');
  const themeIcon = document.getElementById('themeIcon');

  function applyTheme(pref) {
    if (!pref) pref = 'light';
    if (pref === 'dark') {
      document.documentElement.classList.add('dark');
      document.body.classList.add('dark');
      if (themeIcon) themeIcon.src = 'assets/sun-icon.svg';
    } else {
      document.documentElement.classList.remove('dark');
      document.body.classList.remove('dark');
      if (themeIcon) themeIcon.src = 'assets/moon-icon.svg';
    }
  }

  try {
    const saved = localStorage.getItem(THEME_KEY) || 'light';
    applyTheme(saved);
  } catch (e) { /* ignore localStorage errors */ }

  if (themeBtn) {
    themeBtn.addEventListener('click', () => {
      const isDark = document.body.classList.toggle('dark');
      const newPref = isDark ? 'dark' : 'light';
      applyTheme(newPref);
      try { localStorage.setItem(THEME_KEY, newPref); } catch (e) {}
    });
    themeBtn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); themeBtn.click(); } });
  }

  // --- Top search input: populate with current query and handle Enter ---
  const topInput = document.getElementById('topSearchInput');
  if (topInput) {
    topInput.value = rawQuery || '';
    topInput.addEventListener('focus', () => {
      const len = topInput.value.length;
      try { topInput.setSelectionRange(len, len); } catch (e) {}
    });
    topInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const q = topInput.value.trim();
        if (!q) return;
        window.location.href = `/search.html?q=${encodeURIComponent(q)}`;
      }
    });
    // allow clicking to focus and place caret at end
    topInput.addEventListener('click', () => { const len = topInput.value.length; try { topInput.setSelectionRange(len, len); } catch (e) {} });
  }

  const resultsContainer = document.getElementById('results');

  if (!query) {
    resultsContainer.innerHTML = '<li class="no-results">Introduce un término de búsqueda</li>';
  } else {
    fetch(PAGES_JSON)
      .then(r => r.json())
      .then(documents => {
        let idx = null;

        try {
          const cached = localStorage.getItem('lunr_index_v1');
          const cachedDocsCount = Number(localStorage.getItem('lunr_docs_count_v1') || '0');
          if (cached && cachedDocsCount === documents.length) {
            idx = lunr.Index.load(JSON.parse(cached));
          }
        } catch {}

        if (!idx) {
          idx = lunr(function() {
            try { this.pipeline.remove(lunr.stopWordFilter); } catch {}
            try { this.pipeline.add(lunr.generateStopWordFilter(STOPWORDS)); } catch {}

            this.ref('url');
            this.field('keywords', { boost: 10 });

            documents.forEach(doc => {
              this.add({
                url: doc.url,
                keywords: (doc.keywords || '').toString()
              });
            });
          });

          try {
            localStorage.setItem('lunr_index_v1', JSON.stringify(idx));
            localStorage.setItem('lunr_docs_count_v1', documents.length);
          } catch {}
        }

        const tokens = removeStopwords(tokenize(query));
        if (!tokens.length) {
          resultsContainer.innerHTML = '<li class="no-results">La búsqueda contiene solo palabras vacías.</li>';
          return;
        }

        const results = idx.search(tokens.join(' '));
        const docsByUrl = Object.fromEntries(documents.map(d => [d.url, d]));

        if (!results.length) {
          resultsContainer.innerHTML = '<li class="no-results">No se encontraron resultados</li>';
          return;
        }

        const frag = document.createDocumentFragment();
        results.forEach(r => {
          const d = docsByUrl[r.ref];
          const li = document.createElement('li');
          li.className = 'result';
          li.innerHTML = `
            <a href="${d.url}">
              <strong>${escapeHtml(d.title || d.url)}</strong>
              <span class="summary">${d.summary || ''}</span>
            </a>`;
          frag.appendChild(li);
        });

        resultsContainer.appendChild(frag);
      })
      .catch(() => {
        resultsContainer.innerHTML = '<li class="no-results">Error cargando datos de búsqueda.</li>';
      });
  }

  function escapeHtml(s) {
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }
</script>

</body>
</html>
